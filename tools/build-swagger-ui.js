// tools/build-swagger-ui.js
// Build a static Swagger UI site for OCPI OpenAPI specs, compatible with multi-version layout.
// Output structure:
//   dist/swagger-ui/<version>/index.html
//   dist/swagger-ui/<version>/openapi.yaml            (bundled, recommended)
//   dist/swagger-ui/<version>/(swagger-ui assets...)
//   (optional) dist/swagger-ui/<version>/openapi.raw.yaml (root with refs)
//
// Usage:
//   npm i -D swagger-ui-dist swagger-cli yaml
//   node tools/build-swagger-ui.js
//   node tools/build-swagger-ui.js 2.3.0 2.2.1
//
// Assumptions:
// - For each version V, you have a folder: openapi/ocpi-V/
// - The root spec openapi/ocpi-V/openapi.yaml exists (generated by tools/generate-root-openapi.js V)
// - You want one page per version (no version selector)
//
// Notes:
// - We bundle the root spec with swagger-cli to avoid $ref resolution issues in browsers/GitHub Pages.
// - The generated UI includes a "custom server" input stored in localStorage per version.

const fs = require("fs");
const path = require("path");
const { execSync } = require("child_process");

const swaggerUiDistDir = path.dirname(require.resolve("swagger-ui-dist/package.json"));
const swaggerUiAssetsDir = swaggerUiDistDir; // contains swagger-ui.css/js files

const ROOT_DIR = process.cwd();
const DIST_DIR = path.join(ROOT_DIR, "dist", "swagger-ui");

// ---- Helpers ----------------------------------------------------------------
function ensureDir(p) {
  fs.mkdirSync(p, { recursive: true });
}

function copyDirFlat(srcDir, destDir) {
  // Copy only files from swagger-ui-dist directory root (no recursion needed)
  for (const name of fs.readdirSync(srcDir)) {
    const src = path.join(srcDir, name);
    const stat = fs.statSync(src);
    if (stat.isFile()) {
      fs.copyFileSync(src, path.join(destDir, name));
    }
  }
}

function writeFile(p, content) {
  ensureDir(path.dirname(p));
  fs.writeFileSync(p, content, "utf8");
}

function fileExists(p) {
  try {
    fs.accessSync(p, fs.constants.F_OK);
    return true;
  } catch {
    return false;
  }
}

function listOcpiVersionsFromFolders() {
  // Detect folders like openapi/ocpi-2.3.0, openapi/ocpi-2.2.1, ...
  const openApiRoot = path.join(ROOT_DIR, "openapi");
  if (!fileExists(openApiRoot)) {
    return [];
  }
  const entries = fs.readdirSync(openApiRoot, { withFileTypes: true });
  return entries
    .filter((e) => e.isDirectory() && e.name.startsWith("ocpi-"))
    .map((e) => e.name.replace(/^ocpi-/, ""))
    .sort((a, b) => a.localeCompare(b));
}

function bundleOpenApiYaml(inputYamlPath, outputYamlPath) {
  // Use local swagger-cli if available; fallback to npx
  // - yaml output keeps it readable
  const cmd = `npx swagger-cli bundle "${inputYamlPath}" -t yaml -o "${outputYamlPath}"`;
  execSync(cmd, { stdio: "inherit" });
}

function generateIndexHtml(version) {
  // Keep the JS minimal and static-site friendly.
  // Custom server is stored per version key.
  return `<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>OCPI ${version} – Swagger UI</title>
  <link rel="stylesheet" href="./swagger-ui.css" />
  <style>
    body { margin: 0; }
    .topbar {
      padding: 10px;
      background: #fafafa;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      border-bottom: 1px solid #eee;
    }
    .topbar input { width: 420px; max-width: 90vw; }
    .topbar button, .topbar input { padding: 6px 8px; }
  </style>
</head>
<body>
  <div class="topbar">
    <strong>OCPI ${version}</strong>
    <label>Server</label>
    <input id="server" placeholder="https://api.example.com" />
    <button id="apply">Apply</button>
  </div>

  <div id="swagger-ui"></div>

  <script src="./swagger-ui-bundle.js"></script>
  <script src="./swagger-ui-standalone-preset.js"></script>
  <script>
    const STORAGE_KEY = "ocpi.swagger.server.${version}";
    const SPEC_URL = "./openapi.yaml";

    function loadServer() {
      return localStorage.getItem(STORAGE_KEY) || "";
    }

    function saveServer(v) {
      localStorage.setItem(STORAGE_KEY, v);
    }

    function startUI(server) {
      return SwaggerUIBundle({
        url: SPEC_URL,
        dom_id: "#swagger-ui",
        presets: [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset],
        layout: "StandaloneLayout",
        requestInterceptor: (req) => {
          const custom = (server || "").trim();
          if (!custom) return req;

          try {
            // Rewrite origin only, keep path/query generated by Swagger UI.
            const u = new URL(req.url);
            const base = new URL(custom);
            u.protocol = base.protocol;
            u.host = base.host;
            req.url = u.toString();
          } catch (_) {
            // Ignore parsing errors, keep default behavior.
          }
          return req;
        }
      });
    }

    function boot() {
      const server = loadServer();
      document.getElementById("server").value = server;

      startUI(server);

      document.getElementById("apply").onclick = () => {
        const v = document.getElementById("server").value;
        saveServer(v);
        document.getElementById("swagger-ui").innerHTML = "";
        startUI(v);
      };
    }

    boot();
  </script>
</body>
</html>
`;
}

// ---- Main -------------------------------------------------------------------
function main() {
  const versionsFromArgs = process.argv.slice(2).filter(Boolean);
  const versions = versionsFromArgs.length ? versionsFromArgs : listOcpiVersionsFromFolders();

  if (!versions.length) {
    console.error("ERROR: No OCPI versions found. Expected folders like openapi/ocpi-2.3.0/");
    process.exit(1);
  }

  ensureDir(DIST_DIR);

  for (const version of versions) {
    const srcDir = path.join(ROOT_DIR, "openapi", `ocpi-${version}`);
    const srcRootSpec = path.join(srcDir, "openapi.yaml");

    if (!fileExists(srcRootSpec)) {
      console.error(`ERROR: Missing root spec: ${srcRootSpec}`);
      console.error(`Hint: generate it first with: node tools/generate-root-openapi.js ${version}`);
      process.exit(1);
    }

    const outDir = path.join(DIST_DIR, version);
    ensureDir(outDir);

    // 1) Copy Swagger UI static assets to dist/swagger-ui/<version>/
    copyDirFlat(swaggerUiAssetsDir, outDir);

    // 2) Bundle the root spec to avoid $ref HTTP resolution issues in browsers
    const outSpec = path.join(outDir, "openapi.yaml");
    bundleOpenApiYaml(srcRootSpec, outSpec);

    // (Optional) keep a copy of the raw root spec (with refs) for debugging
    // fs.copyFileSync(srcRootSpec, path.join(outDir, "openapi.raw.yaml"));

    // 3) Generate index.html for this version (no version selector)
    writeFile(path.join(outDir, "index.html"), generateIndexHtml(version));

    console.log(`✔ Built Swagger UI for OCPI ${version}: ${path.relative(ROOT_DIR, outDir)}/index.html`);
  }

  console.log("\nLocal test:");
  console.log("  cd dist/swagger-ui");
  console.log("  python3 -m http.server 8080");
  console.log("\nThen open:");
  console.log("  http://localhost:8080/<version>/");
}

main();
