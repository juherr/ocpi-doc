// tools/build-swagger-ui.js
// Build a static Swagger UI site for OCPI OpenAPI specs, compatible with multi-version layout.
// Output structure:
//   public/api/<version>/swagger/index.html
//   public/api/<version>/swagger/openapi.yaml            (bundled, recommended)
//   public/api/<version>/swagger/(swagger-ui assets...)
//   (optional) public/api/<version>/swagger/openapi.raw.yaml (root with refs)
//
// Usage:
//   npm i -D swagger-ui-dist swagger-cli yaml
//   node tools/build-swagger-ui.js
//   node tools/build-swagger-ui.js 2.3.0 2.2.1
//
// Assumptions:
// - For each version V, you have a folder: openapi/ocpi-V/
// - The root spec openapi/ocpi-V/openapi.yaml exists (generated by tools/generate-root-openapi.js V)
// - You want one page per version (no version selector)
//
// Notes:
// - We bundle the root spec with Redocly CLI to avoid $ref resolution issues in browsers/GitHub Pages
//   while preserving reusable named schemas for Swagger UI/codegen readability.
// - The generated UI includes a "custom server" input stored in localStorage per version.

const fs = require("fs");
const path = require("path");
const { execSync } = require("child_process");
const YAML = require("yaml");

const swaggerUiDistDir = path.dirname(require.resolve("swagger-ui-dist/package.json"));
const swaggerUiAssetsDir = swaggerUiDistDir; // contains swagger-ui.css/js files

const ROOT_DIR = process.cwd();
const PUBLIC_API_DIR = path.join(ROOT_DIR, "public", "api");

// ---- Helpers ----------------------------------------------------------------
function ensureDir(p) {
  fs.mkdirSync(p, { recursive: true });
}

function copyDirFlat(srcDir, destDir) {
  // Copy only files from swagger-ui-dist directory root (no recursion needed)
  for (const name of fs.readdirSync(srcDir)) {
    const src = path.join(srcDir, name);
    const stat = fs.statSync(src);
    if (stat.isFile()) {
      fs.copyFileSync(src, path.join(destDir, name));
    }
  }
}

function writeFile(p, content) {
  ensureDir(path.dirname(p));
  fs.writeFileSync(p, content, "utf8");
}

function fileExists(p) {
  try {
    fs.accessSync(p, fs.constants.F_OK);
    return true;
  } catch {
    return false;
  }
}

function listOcpiVersionsFromFolders() {
  // Detect folders like openapi/ocpi-2.3.0, openapi/ocpi-2.2.1, ...
  const openApiRoot = path.join(ROOT_DIR, "openapi");
  if (!fileExists(openApiRoot)) {
    return [];
  }
  const entries = fs.readdirSync(openApiRoot, { withFileTypes: true });
  return entries
    .filter((e) => e.isDirectory() && e.name.startsWith("ocpi-"))
    .map((e) => e.name.replace(/^ocpi-/, ""))
    .sort((a, b) => a.localeCompare(b));
}

function bundleOpenApiYaml(inputYamlPath, outputYamlPath) {
  // Use Redocly bundle to preserve named reusable schemas.
  const cmd = `npx --yes @redocly/cli bundle "${inputYamlPath}" --output "${outputYamlPath}"`;
  execSync(cmd, { stdio: "inherit" });
}

function normalizeHeaderGroupingInBundle(outputYamlPath) {
  const doc = YAML.parse(fs.readFileSync(outputYamlPath, "utf8"));
  const paths = doc.paths || {};
  const components = doc.components || {};
  const parameters = components.parameters || {};

  const methods = ["get", "put", "post", "patch", "delete", "options", "head", "trace"];
  const correlationHeaders = ["X-Request-ID", "X-Correlation-ID"];
  const routingHeaders = [
    "OCPI-from-country-code",
    "OCPI-from-party-id",
    "OCPI-to-country-code",
    "OCPI-to-party-id",
  ];

  function resolveHeaderName(param) {
    if (!param || typeof param !== "object") return null;
    if (param.$ref) {
      const m = param.$ref.match(/^#\/components\/parameters\/(.+)$/);
      if (!m) return null;
      const key = decodeURIComponent(m[1]);
      const p = parameters[key];
      if (p && p.in === "header") {
        return p.name || key;
      }
      return null;
    }
    if (param.in === "header") {
      return param.name || null;
    }
    return null;
  }

  function headerRef(name) {
    return { $ref: `#/components/parameters/${encodeURIComponent(name)}` };
  }

  for (const [pathKey, pathItem] of Object.entries(paths)) {
    if (!pathItem || typeof pathItem !== "object") continue;

    const opNames = methods.filter((m) => pathItem[m] && typeof pathItem[m] === "object");
    if (opNames.length === 0) continue;

    const isExceptionPath = pathKey.startsWith("/versions") || pathKey.startsWith("/credentials");
    const targetHeaders = isExceptionPath
      ? correlationHeaders
      : correlationHeaders.concat(routingHeaders);

    if (!Array.isArray(pathItem.parameters)) {
      pathItem.parameters = [];
    }

    const pathHeaderSet = new Set(
      pathItem.parameters.map((p) => resolveHeaderName(p)).filter(Boolean),
    );

    for (const h of targetHeaders) {
      if (!pathHeaderSet.has(h)) {
        pathItem.parameters.push(headerRef(h));
      }
    }

    for (const opName of opNames) {
      const operation = pathItem[opName];
      if (!Array.isArray(operation.parameters)) continue;

      operation.parameters = operation.parameters.filter((p) => {
        const h = resolveHeaderName(p);
        return !(h && targetHeaders.includes(h));
      });

      if (operation.parameters.length === 0) {
        delete operation.parameters;
      }
    }
  }

  fs.writeFileSync(outputYamlPath, YAML.stringify(doc), "utf8");
}

function generateIndexHtml(version) {
  // Keep the JS minimal and static-site friendly.
  // Custom server is stored per version key.
  return `<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>OCPI ${version} â€“ Swagger UI</title>
  <link rel="stylesheet" href="./swagger-ui.css" />
  <style>
    body { margin: 0; background: #f8fafc; }
    .topbar {
      min-height: 56px;
      padding: 8px 16px;
      background: #171717;
      color: #ffffff;
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      border-bottom: 1px solid #2b2b2b;
    }
    .topbar .topbar-left {
      display: inline-flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .topbar .back-link {
      display: inline-flex;
      align-items: center;
      color: #e5e7eb;
      font-family: Arial, sans-serif;
      font-size: 13px;
      font-weight: 600;
      line-height: 1;
      text-decoration: none;
      white-space: nowrap;
    }
    .topbar .back-link:hover,
    .topbar .back-link:focus {
      color: #ffffff;
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    .topbar .version-label {
      color: #9ca3af;
      font-family: Arial, sans-serif;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      white-space: nowrap;
    }
    .topbar .topbar-tools {
      margin-left: auto;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .topbar input { width: 420px; max-width: 90vw; }
    .topbar button, .topbar input { padding: 6px 8px; }
    .topbar input {
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: #ffffff;
      color: #0f172a;
    }
    .topbar .topbar-tools label {
      color: #e5e7eb;
      font-size: 13px;
      font-weight: 600;
    }
    .topbar #apply {
      border: 1px solid #334155;
      border-radius: 6px;
      background: #ffffff;
      color: #1e293b;
      font-weight: 600;
      cursor: pointer;
    }
    .topbar #apply:hover,
    .topbar #apply:focus {
      background: #e2e8f0;
      border-color: #475569;
    }
    @media (max-width: 768px) {
      .topbar {
        min-height: 0;
        padding: 10px 12px;
        gap: 8px;
      }
      .topbar .topbar-tools {
        width: 100%;
        margin-left: 0;
      }
      .topbar input {
        width: min(420px, 100%);
      }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-left">
      <a class="back-link" href="/ocpi/${version}/index.html">Back to specification</a>
      <span class="version-label">OCPI ${version} - Swagger UI</span>
    </div>
    <div class="topbar-tools">
      <label for="server">Server</label>
      <input id="server" placeholder="https://api.example.com" />
      <button id="apply">Apply</button>
    </div>
  </div>

  <div id="swagger-ui"></div>

  <script src="./swagger-ui-bundle.js"></script>
  <script>
    const STORAGE_KEY = "ocpi.swagger.server.${version}";
    const SPEC_URL = "./openapi.yaml";

    function loadServer() {
      return localStorage.getItem(STORAGE_KEY) || "";
    }

    function saveServer(v) {
      localStorage.setItem(STORAGE_KEY, v);
    }

    function startUI(server) {
      return SwaggerUIBundle({
        url: SPEC_URL,
        dom_id: "#swagger-ui",
        presets: [SwaggerUIBundle.presets.apis],
        layout: "BaseLayout",
        deepLinking: true,
        docExpansion: "list",
        defaultModelsExpandDepth: 1,
        displayRequestDuration: true,
        filter: true,
        tagsSorter: "alpha",
        operationsSorter: "alpha",
        persistAuthorization: true,
        tryItOutEnabled: true,
        validatorUrl: null,
        requestInterceptor: (req) => {
          const custom = (server || "").trim();
          if (!custom) return req;

          try {
            // Rewrite origin only, keep path/query generated by Swagger UI.
            const u = new URL(req.url);
            const base = new URL(custom);
            u.protocol = base.protocol;
            u.host = base.host;
            req.url = u.toString();
          } catch (_) {
            // Ignore parsing errors, keep default behavior.
          }
          return req;
        }
      });
    }

    function boot() {
      const server = loadServer();
      document.getElementById("server").value = server;

      startUI(server);

      document.getElementById("apply").onclick = () => {
        const v = document.getElementById("server").value;
        saveServer(v);
        document.getElementById("swagger-ui").innerHTML = "";
        startUI(v);
      };
    }

    boot();
  </script>
</body>
</html>
`;
}

// ---- Main -------------------------------------------------------------------
function main() {
  const versionsFromArgs = process.argv.slice(2).filter(Boolean);
  const versions = versionsFromArgs.length ? versionsFromArgs : listOcpiVersionsFromFolders();

  if (!versions.length) {
    console.error("ERROR: No OCPI versions found. Expected folders like openapi/ocpi-2.3.0/");
    process.exit(1);
  }

  ensureDir(PUBLIC_API_DIR);

  for (const version of versions) {
    const srcDir = path.join(ROOT_DIR, "openapi", `ocpi-${version}`);
    const srcRootSpec = path.join(srcDir, "openapi.yaml");

    if (!fileExists(srcRootSpec)) {
      console.error(`ERROR: Missing root spec: ${srcRootSpec}`);
      console.error(`Hint: generate it first with: node tools/generate-root-openapi.js ${version}`);
      process.exit(1);
    }

    const outDir = path.join(PUBLIC_API_DIR, version, "swagger");
    if (fileExists(outDir)) {
      fs.rmSync(outDir, { recursive: true, force: true });
    }
    ensureDir(outDir);

    // 1) Copy Swagger UI static assets to public/api/<version>/swagger/
    copyDirFlat(swaggerUiAssetsDir, outDir);

    // 2) Bundle the root spec to avoid $ref HTTP resolution issues in browsers
    const outSpec = path.join(outDir, "openapi.yaml");
    bundleOpenApiYaml(srcRootSpec, outSpec);
    normalizeHeaderGroupingInBundle(outSpec);

    // (Optional) keep a copy of the raw root spec (with refs) for debugging
    // fs.copyFileSync(srcRootSpec, path.join(outDir, "openapi.raw.yaml"));

    // 3) Generate index.html for this version (no version selector)
    writeFile(path.join(outDir, "index.html"), generateIndexHtml(version));

    console.log(`Built Swagger UI for OCPI ${version}: public/api/${version}/swagger/index.html`);
  }

  console.log("\nSwagger UI pages are available under public/api/<version>/swagger/");
}

main();
